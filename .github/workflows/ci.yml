name: CI
on:
  pull_request:

concurrency:
  # Cancel any running workflow for the same branch when new commits are pushed.
  # We group both by ref_name (available when CI is triggered by a push to a branch/tag)
  # and head_ref (available when CI is triggered by a PR).
  group: "${{ github.ref_name }}-${{ github.head_ref }}"
  cancel-in-progress: true

# Needed to login to DockerHub
permissions:
  contents: read
  id-token: write

jobs:
  get-image-tag:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: get-tag
        run: |
          echo "tag=$(./tools/image-tag)" >> "$GITHUB_OUTPUT"

  docker:
    needs: get-image-tag
    strategy:
      matrix:
        component: [ tempo, tempo-vulture, tempo-query, tempo-cli ]
        runner_arch: [ { runner: ubuntu-24.04, arch: amd64 }, { runner: github-hosted-ubuntu-arm64, arch: arm64 } ]
    runs-on: ${{ matrix.runner_arch.runner }}
    env:
      TAG: ${{ needs.get-image-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: grafana/shared-workflows/actions/dockerhub-login@dockerhub-login-v1.0.0

      - name: build-tempo-binaries
        run: |
          COMPONENT=${{ matrix.component }} GOARCH=${{ matrix.runner_arch.arch }} make exe

      - name: docker-build-and-push-tempo
        run: |
          TAG_ARCH="$TAG-${{ matrix.runner_arch.arch }}"
          docker build -f cmd/${{ matrix.component }}/Dockerfile -t grafana/${{ matrix.component }}:TAG_ARCH .
          #docker push grafana/${{ matrix.component }}:TAG_ARCH
