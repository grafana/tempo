# This triggers on every push to main and finds the PR that was merged.
# If the PR has any "backport release-*" labels, it opens a backport PR
# targeting each labeled release branch.
#
# Manual re-trigger: Go to Actions → Backport PR Creator → Run workflow,
# provide the PR number. Note: running twice on the same PR will post a
# failure comment on the original PR (no deduplication).
name: Backport PR Creator

on:
  push:
    branches:
      - automate-backport-process
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to backport (required for manual trigger)'
        required: true
        type: string

permissions: {}

jobs:
  find-pr:
    name: Find PR and check backport labels
    # skip in forks — only run in grafana/tempo
    if: github.repository == 'grafana/tempo'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      has_backport_labels: ${{ steps.check-labels.outputs.has_backport_labels }}
    steps:
      - name: Find PR number
        id: find-pr
        env:
          GH_TOKEN: ${{ github.token }}
          EVENT_NAME: ${{ github.event_name }}
          INPUT_PR_NUMBER: ${{ inputs.pr_number }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            PR_NUMBER="$INPUT_PR_NUMBER"
          else
            PR_NUMBER=$(gh api \
              "repos/${REPO}/commits/${SHA}/pulls" \
              --header "Accept: application/vnd.github+json" \
              --jq '.[0].number // empty')
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for commit ${SHA}, skipping backport."
          else
            echo "Found PR number: $PR_NUMBER"
          fi
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Check for backport labels
        id: check-labels
        if: steps.find-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          REPO: ${{ github.repository }}
        run: |
          COUNT=$(gh pr view "$PR_NUMBER" \
            --repo "$REPO" \
            --json labels \
            --jq '[.labels[].name | select(startswith("backport release-"))] | length')

          if [ "$COUNT" -gt "0" ]; then
            echo "Found $COUNT backport label(s), will run backport."
            echo "has_backport_labels=true" >> "$GITHUB_OUTPUT"
          else
            echo "No backport labels found, skipping backport."
            echo "has_backport_labels=false" >> "$GITHUB_OUTPUT"
          fi

  backport:
    name: Backport PR
    needs: find-pr
    if: |
      needs.find-pr.outputs.pr_number != '' &&
      needs.find-pr.outputs.has_backport_labels == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Get Github App secrets from vault
        id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@e6dde86ffefaa91fc693b8cb4209cf9428a661d1 # get-vault-secrets 1.3.0
        with:
          export_env: false
          repo_secrets: |
            APP_ID=tempo-ci-app:app-id
            PRIVATE_KEY=tempo-ci-app:private-key

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ fromJSON(steps.get-secrets.outputs.secrets).APP_ID }}
          private-key: ${{ fromJSON(steps.get-secrets.outputs.secrets).PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: tempo

      - name: Run backport
        uses: grafana/grafana-github-actions-go/backport@main
        with:
          token: ${{ steps.app-token.outputs.token }}
          labelsToAdd: "backport"
          pr_number: ${{ needs.find-pr.outputs.pr_number }}
          repo_owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
